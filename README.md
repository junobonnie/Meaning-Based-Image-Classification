# Meaning-Based Image Classification (Hybrid Model)

ì´ í”„ë¡œì íŠ¸ëŠ” **MobileNetV3** (ì‹œê°ì  íŠ¹ì§•)ì™€ **CLIP** (ì˜ë¯¸ì  íŠ¹ì§•)ì„ ê²°í•©í•œ í•˜ì´ë¸Œë¦¬ë“œ ì´ë¯¸ì§€ ë¶„ë¥˜ê¸°ì…ë‹ˆë‹¤. ì´ë¯¸ì§€ê°€ ì–´ë–»ê²Œ ìƒê²¼ëŠ”ì§€ë¿ë§Œ ì•„ë‹ˆë¼, ì´ë¯¸ì§€ê°€ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ì§€ê¹Œì§€ ê³ ë ¤í•˜ì—¬ ë¶„ë¥˜ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.

## ğŸ“Œ ì£¼ìš” ê¸°ëŠ¥

- **í•˜ì´ë¸Œë¦¬ë“œ ì•„í‚¤í…ì²˜**: CNN ê¸°ë°˜ì˜ MobileNetV3ì™€ Transformer ê¸°ë°˜ì˜ CLIP ëª¨ë¸ì„ ì•™ìƒë¸”í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
- **ìœ ì—°í•œ ëª¨ë“œ ì„ íƒ**:
  - `hybrid`: MobileNetV3 + CLIP (ê¶Œì¥)
  - `mobilenet`: MobileNetV3ë§Œ ì‚¬ìš© (ê¸°ì¡´ CNN ë°©ì‹)
  - `clip`: CLIPë§Œ ì‚¬ìš© (í…ìŠ¤íŠ¸-ì´ë¯¸ì§€ ì˜ë¯¸ì  ì—°ê²° í™œìš©)
- **ì•ˆì „í•œ ëª¨ë¸ ë¡œë”©**: `safetensors`ë¥¼ ì‚¬ìš©í•˜ì—¬ `torch.load` ë³´ì•ˆ ì·¨ì•½ì ì„ ë°©ì§€í•©ë‹ˆë‹¤.
- **ìë™í™”ëœ íŒŒì´í”„ë¼ì¸**: ë°ì´í„° ë¡œë“œ, ì „ì²˜ë¦¬, í•™ìŠµ, ê²€ì¦, í‰ê°€ê¹Œì§€ì˜ ì „ì²´ ê³¼ì •ì„ ì§€ì›í•©ë‹ˆë‹¤.

## ğŸ› ï¸ ì„¤ì¹˜ ë°©ë²• (Installation)

í•„ìš”í•œ Python íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.

```bash
pip install -r requirements.txt
```

> **ì°¸ê³ **: CLIP ëª¨ë¸ ë¡œë”© ì‹œ ë³´ì•ˆì„ ìœ„í•´ `safetensors` íŒ¨í‚¤ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤. `requirements.txt`ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

## ë°ì´í„°ì…‹ ì¤€ë¹„ (Data Preparation)

ë°ì´í„°ì…‹ì€ ë‹¤ìŒê³¼ ê°™ì€ í´ë” êµ¬ì¡°ë¡œ ì¤€ë¹„í•´ì•¼ í•©ë‹ˆë‹¤. ê° í´ë”ì˜ ì´ë¦„ì´ í´ë˜ìŠ¤(ë ˆì´ë¸”) ì´ë¦„ì´ ë©ë‹ˆë‹¤.

```
dataset/
â”œâ”€â”€ dog/
â”‚   â”œâ”€â”€ image1.jpg
â”‚   â”œâ”€â”€ image2.png
â”‚   â””â”€â”€ ...
â”œâ”€â”€ cat/
â”‚   â”œâ”€â”€ image1.jpg
â”‚   â””â”€â”€ ...
â””â”€â”€ car/
    â””â”€â”€ ...
```

## ğŸš€ ì‚¬ìš© ë°©ë²• (Usage)

### 1. ëª¨ë¸ í•™ìŠµ (Training)

`src/train.py` ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì„ í•™ìŠµì‹œí‚µë‹ˆë‹¤.

**ê¸°ë³¸ ì‚¬ìš©ë²•:**
```bash
python src/train.py --data_dir ./path/to/dataset
```

**ì£¼ìš” ì˜µì…˜:**
- `--data_dir`: (í•„ìˆ˜) ë°ì´í„°ì…‹ì´ ìœ„ì¹˜í•œ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ê²½ë¡œ.
- `--epochs`: í•™ìŠµ ì—í­ ìˆ˜ (ê¸°ë³¸ê°’: 10).
- `--batch_size`: ë°°ì¹˜ í¬ê¸° (ê¸°ë³¸ê°’: 32).
- `--lr`: í•™ìŠµë¥  (ê¸°ë³¸ê°’: 0.001).
- `--mode`: ëª¨ë¸ ëª¨ë“œ ì„ íƒ (`hybrid`, `mobilenet`, `clip` ì¤‘ íƒ1, ê¸°ë³¸ê°’: `hybrid`).
- `--output_dir`: ì²´í¬í¬ì¸íŠ¸ ë° ë¡œê·¸ ì €ì¥ ê²½ë¡œ (ê¸°ë³¸ê°’: `checkpoints`).
- `--max_samples`: í´ë˜ìŠ¤ë³„ í•™ìŠµì— ì‚¬ìš©í•  ìµœëŒ€ ë°ì´í„° ê°œìˆ˜ (ë””ë²„ê¹…ìš©, ê¸°ë³¸ê°’: None). ì˜ˆë¥¼ ë“¤ì–´ 10ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ê° í´ë˜ìŠ¤ë‹¹ ìµœëŒ€ 10ê°œì˜ ì´ë¯¸ì§€ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- `--patience`: Early Stoppingì„ ìœ„í•œ ê¸°ë‹¤ë¦¼ ì—í­ ìˆ˜ (ê¸°ë³¸ê°’: 5). 0ìœ¼ë¡œ ì„¤ì •í•˜ë©´ Early Stoppingì„ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
- `--fine_tune`: ì´ í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•˜ë©´ Feature Extraction í›„ Fine-tuning ë‹¨ê³„ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
- `--ft_lr`: Fine-tuning ë‹¨ê³„ì˜ í•™ìŠµë¥  (ê¸°ë³¸ê°’: 1e-4).
- `--ft_epochs`: Fine-tuning ë‹¨ê³„ì˜ ìµœëŒ€ ì—í­ ìˆ˜ (ê¸°ë³¸ê°’: 5).

**ì˜ˆì‹œ:**
```bash
# í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œë¡œ 20 ì—í­ í•™ìŠµ
python src/train.py --data_dir ./data/my_dataset --epochs 20 --mode hybrid --output_dir ./results
```

### 2. ëª¨ë¸ í‰ê°€ (Evaluation)

í•™ìŠµëœ ì²´í¬í¬ì¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì˜ ì„±ëŠ¥ì„ í‰ê°€í•©ë‹ˆë‹¤. `src/evaluate.py`ë¥¼ ì‹¤í–‰í•˜ë©´ ë¶„ë¥˜ ë³´ê³ ì„œ(Classification Report)ì™€ í˜¼ë™ í–‰ë ¬(Confusion Matrix) ì´ë¯¸ì§€ê°€ ìƒì„±ë©ë‹ˆë‹¤.

**ì‚¬ìš©ë²•:**
```bash
python src/evaluate.py --data_dir ./path/to/dataset --checkpoint ./checkpoints/checkpoint_hybrid_last.pth.tar
```

**ì£¼ìš” ì˜µì…˜:**
- `--data_dir`: (í•„ìˆ˜) í‰ê°€í•  ë°ì´í„°ì…‹ ê²½ë¡œ (í•™ìŠµ ë°ì´í„°ì™€ ë™ì¼í•œ êµ¬ì¡°).
- `--checkpoint`: (í•„ìˆ˜) í•™ìŠµëœ ëª¨ë¸ì˜ ì²´í¬í¬ì¸íŠ¸ íŒŒì¼ ê²½ë¡œ (.pth.tar).
- `--batch_size`: ë°°ì¹˜ í¬ê¸° (ê¸°ë³¸ê°’: 32).

### 3. ì´ë¯¸ì§€ ë¶„ë¥˜ ë° ì •ë ¬ (Inference & Sort)

í•™ìŠµëœ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • í´ë”(`input_dir`)ì— ìˆëŠ” ì´ë¯¸ì§€ë“¤ì„ ë¶„ë¥˜í•˜ê³ , ê²°ê³¼ í´ë”(`output_dir`) ë‚´ì— í´ë˜ìŠ¤ë³„ë¡œ í´ë”ë¥¼ ìƒì„±í•˜ì—¬ ë³µì‚¬í•©ë‹ˆë‹¤.

**ì‚¬ìš©ë²•:**
```bash
python src/inference_sort.py --input_dir ./input_images --output_dir ./sorted_images --checkpoint ./results/checkpoint_hybrid_last.pth.tar
```

**ì£¼ìš” ì˜µì…˜:**
- `--input_dir`: (í•„ìˆ˜) ë¶„ë¥˜í•  ì´ë¯¸ì§€ê°€ ë“¤ì–´ìˆëŠ” í´ë” ê²½ë¡œ.
- `--output_dir`: (í•„ìˆ˜) ë¶„ë¥˜ëœ ì´ë¯¸ì§€ê°€ ì €ì¥ë  í´ë” ê²½ë¡œ.
- `--checkpoint`: (í•„ìˆ˜) í•™ìŠµëœ ëª¨ë¸ ì²´í¬í¬ì¸íŠ¸ ê²½ë¡œ.
- `--threshold`: ë¶„ë¥˜ í™•ì‹ ë„ ì„ê³„ê°’ (0.0 ~ 1.0, ê¸°ë³¸ê°’: 0.0). ì´ ê°’ë³´ë‹¤ ë‚®ì€ í™•ë¥ ë¡œ ì˜ˆì¸¡ëœ ì´ë¯¸ì§€ëŠ” `others_dir`ë¡œ ì´ë™í•©ë‹ˆë‹¤.
- `--others_dir`: ì„ê³„ê°’ ë¯¸ë§Œì¸ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•  í´ë” ì´ë¦„ (ê¸°ë³¸ê°’: `others`).

## âš ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… (Troubleshooting)

### `torch.load` ë³´ì•ˆ ì·¨ì•½ì  ì˜¤ë¥˜ (Vulnerability Error)

í•™ìŠµ ì‹¤í–‰ ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
```
FutureWarning: You are using `torch.load` with `weights_only=False`...
Due to a serious vulnerability issue in `torch.load`...
```

**í•´ê²° ë°©ë²•**:
ì´ í”„ë¡œì íŠ¸ëŠ” `safetensors`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤. ë§Œì•½ ì´ ì˜¤ë¥˜ê°€ ê³„ì† ë°œìƒí•œë‹¤ë©´ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:
1. `safetensors` íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (`pip install safetensors`)
2. `src/model.py`ì™€ `src/train.py`ì—ì„œ `use_safetensors=True` ì˜µì…˜ì´ ì ìš©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

## ğŸ“‚ íŒŒì¼ êµ¬ì¡°

```
.
â”œâ”€â”€ requirements.txt    # ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ëª©ë¡
â”œâ”€â”€ README.md           # í”„ë¡œì íŠ¸ ì„¤ëª…ì„œ
â””â”€â”€ src/
    â”œâ”€â”€ dataset.py      # ë°ì´í„°ì…‹ ë¡œë“œ ë° ì „ì²˜ë¦¬ í´ë˜ìŠ¤
    â”œâ”€â”€ model.py        # HybridClassifier ëª¨ë¸ ì •ì˜
    â”œâ”€â”€ train.py        # í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸
    â”œâ”€â”€ evaluate.py     # í‰ê°€ ìŠ¤í¬ë¦½íŠ¸
    â”œâ”€â”€ inference_sort.py # ì´ë¯¸ì§€ ë¶„ë¥˜ ë° ì •ë ¬ ìŠ¤í¬ë¦½íŠ¸
    â””â”€â”€ utils.py        # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ì‹œê°í™”, ì²´í¬í¬ì¸íŠ¸ ì €ì¥ ë“±)
```
